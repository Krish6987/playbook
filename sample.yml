---
- hosts: sonar
  become: true
  tasks:      
  - name: Install unzip
    apt:
      name: unzip
      state: present
      
  - name: install jdk
    apt:
      name: default-jdk
      state: present
      
  - name: Create sonar user
    user:
      name: sonar
  
  - name: Create sonar directory
    file:
      path: "/opt/sonar"
      state: directory

  - name: Extract SonarQube
    unarchive:
      src: https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-8.0.zip
      dest: /opt/sonar/
      remote_src: yes
      
  - name: Link this version of sonarqube as the server SonarQube version
    file:
      src: "/opt/sonar/sonarqube-8.0"
      dest: "/opt/sonarqube"
      state: link
      owner: sonar
 
  - name: Configure SonarQube to run as the sonar user
    lineinfile:
      path: "/opt/sonarqube/bin/linux-x86-64/sonar.sh"
      regexp: "RUN_AS_USER=sonar"
      insertafter: "#RUN_AS_USER="
      line: "RUN_AS_USER=sonar"
      
  - name: Copy sonar service to systemd
    become: yes
    copy:
      src: /home/ansadmin/playbook/sonarqube.service
      dest: /etc/systemd/system/

  - name: Enable the SonarQube service
    become: yes
    systemd:
      state: started
      enabled: yes
      daemon_reload: yes
      name: sonarqube
